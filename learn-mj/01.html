<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div id="head">청일 3~7 7장 연습</div>

<div id="hands"></div>

<div id="foot">하단3</div>
<hr>
<div id="log">로그기록</div>

<script>
document.getElementById("log").innerText = "";
function log(a){
  document.getElementById("log").innerText += a+"\n";
}
/**********************
*  Initial Value
**********************/
var handsize = 13;
/**********************
*  Only 7tile mode
**********************/
var tile7mode = 1;
var tile7min, tile7max, onecolor;
if(tile7mode) {
  onecolor = Math.floor(Math.random()*3);
  onecolor = 1; // easy mode only Tong
  handsize = 7;
  tile7min = 3;
  tile7max = 7;
}
/**********************
* 마작패 종류 코드 -> 마작패 이미지
* 만수 1~9 : 1~9
* 통수 1~9 : 11~19
* 삭수 1~9 : 21~29
* 동남서북 백발중 : 31~37
**********************/
var tileimg = []; // tile code -> tile img src
for (var i = 0; i < 4; i++) {
   var tilecate;
   if(i == 0) { tilecate = "m"; }
   else if(i == 1) { tilecate = "p"; }
   else if(i == 2) { tilecate = "s"; }
   else if(i == 3) { tilecate = "z"; }
   else { tilecate = ""; }

   if(tilecate != "z") {
     for (var j = 0; j < 9; j++) {
       var textnum = j+1;
       var tcode = i*10+j+1;
       tileimg[tcode] = '<img src="img/'+textnum+tilecate+'.gif">';
     }
   } else {
     for (var j = 0; j < 7; j++) {
       var textnum = j+1;
       var tcode = i*10+j+1;
       tileimg[tcode] = '<img src="img/'+textnum+tilecate+'.gif">';
     }
   }
}

var tilemt = []; // 패산
if(tile7mode) {
  var i = onecolor;
  for (var j = tile7min-1; j < tile7max ; j++) {
     var tcode = i*10+j+1;
     tilemt.push(tcode,tcode,tcode,tcode); // 같은 패 4개씩
  //   log(tcode+" into tilemt(7mode)");
  }
} else {
  for (var i = 0; i < 4; i++) {
     if(tilecate < 3) {
       for (var j = 0; j < 9; j++) {
         var tcode = i*10+j+1;
         tilemt.push(tcode,tcode,tcode,tcode); // 같은 패 4개씩
       }
     } else {
       for (var j = 0; j < 7; j++) {
         var tcode = i*10+j+1;
         tilemt.push(tcode,tcode,tcode,tcode); // 같은 패 4개씩
       }
     }
   }
}

/**********************
* Shuffle function and Sort function
* Shuffles array in place. ES6 version
* @param {Array} a items An array containing the items.
**********************/
function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

function tilesort(a) {
    a.sort(function(a, b){return a - b});
}

function mySum(total,num) {
  return total + num;
}
/**********************
*  패산 섞기 & 손패 뽑기+정렬
**********************/
shuffle(tilemt);
var handtiles = [];
for (var i = 0; i < handsize; i++) {
   var tsumo = tilemt.shift();
   //   log("tsumo "+tsumo);
   handtiles.push(tsumo);
}
tilesort(handtiles);


/**********************
// 손패 출력
**********************/
function showhands(tiles,size,mode) {
  var handhtml = "";
  for (var i = 0; i < size; i++) {
    handhtml += tileimg[tiles[i]];
    //    log("handtileimg "+tileimg[tiles[i]]);
  }
  // 7tilemode용 추가 몸통 출력
  var dumbody = "";
  if(mode==1) {
    var ran1 = 30+Math.floor(Math.random()*4+1);
    var ran2 = 30+Math.floor(Math.random()*3+5);
    //    log("ran1 = "+ran1);
    //   log("ran2 = "+ran2);
    for (var i = 0; i < 3;i++) {
      dumbody += tileimg[ran1];
    }
    for (var i = 0; i < 3;i++) {
      dumbody += tileimg[ran2];
    }
  }
  document.getElementById('hands').innerHTML = handhtml+dumbody;
}
showhands(handtiles,handsize,tile7mode)

/**********************
// winninghand 화료 상태 체크
**********************/
function bodycheck(counts) {
  if(counts.reduce(mySum) == 0) { return 1; }

  var man = counts.slice(1,10);
  var ping = counts.slice(11,20);
  var sou = counts.slice(21,30);
  for(i = 31; i < 38; i++) { // 자패 몸통 확인
    if(counts[i] != 0 & counts[i] != 3) {
      log("자패 몸통 미완성");
      return 0;
    }
  }

  var mans = man.reduce(mySum);
  var pings = ping.reduce(mySum);
  var sous = sou.reduce(mySum);
//  log("수패 합 : "+mans+","+pings+","+sous);
  if(mans%3 > 0 | pings%3 > 0 | sous%3 > 0) {
    log("수패 숫자 안맞음."+mans+","+pings+","+sous);
    return 0;
  }

  var alltcode = [1,2,3,4,5,6,7,8,9,11,12,13,14,15,16,17,18,19,21,22,23,24,25,26,27,28,29,31,32,33,34,35,36,37];
  for(let icode of alltcode) {  // 커쯔 체크
    if(counts[icode] >= 3) {
      counts[icode] -= 3;
      if(bodycheck(counts)) {
        return 1;
      } else {
        counts[icode] += 3;
      }
    }
  }
  var allstr = [1,2,3,4,5,6,7,11,12,13,14,15,16,17,21,22,23,24,25,26,27];
  for(let istr of allstr) {
    if(counts[istr] >=1 & counts[istr+1] >=1 & counts[istr+2] >= 1) {
      counts[istr] -= 1;
      counts[istr+1] -= 1;
      counts[istr+2] -= 1;
      if(bodycheck(counts)) {
        return 1;
      } else {
        counts[istr] += 1;
        counts[istr+1] += 1;
        counts[istr+2] += 1;
      }
    }

  }
}

function winninghand(tiles) {
  // test chitoitsu

  var size = tiles.length;
//  log("\nwinninghand size = "+size);
  if(size == 14 | size == 11 | size == 8) {
    var tilecount = new Array(40);
    tilecount.fill(0);

    var rmtiles = tiles.slice();
    for (var i = 0; i < size; i++) { // rmtiles -> tilecount
      var tcode = rmtiles.shift();
      tilecount[tcode] += 1;
      //      log("tcode = "+tcode);
      //     log("tilecount[tcode] = "+tilecount[tcode]);
    }

    // 머리 체크
    var headtiles = [];
    var nohead = 1;
    for (var i = 0; i < tilecount.length; i++) { // headtiles count
      if(tilecount[i]>=2) {
        headtiles.push(i);
        nohead = 0;
      }
    }
    if(nohead) {
      return 0;
    } else {
      for(let ihead of headtiles) { // for each head
//        log(ihead);
        tilecount[ihead] -= 2;
        if(bodycheck(tilecount)) {
          //          log("WIN");
          return 1;
        }
        tilecount[ihead] += 2;
      }
    }
  } else {
    log("winninghand: Hand size is invalid.")
  }
}

/**********************
// tile7mode 텐파이 체크 판정
**********************/
if(tile7mode) {
  var wintiles = [];
  for (var itile=1 ; itile < 10 ; itile++) {
    var dhandtiles=handtiles.slice();
    dhandtiles.push((onecolor*10+itile));
    if(winninghand(dhandtiles)) {
      wintiles.push(itile+onecolor*10);
      //      log("WIN");
    } else {
    }
  }
  log("wintiles = "+wintiles);
}

/**********************
// 기타 출력
**********************/
log("");
log("remaining tilemt : "+tilemt);
log("handtile codes : "+ handtiles);
</script>

</body>
</html>
